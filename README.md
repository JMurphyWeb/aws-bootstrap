# aws-bootstrap

## Starting from Scratch

**Create User & Admin IAM user**
- Create root user account
- Create an Administrator user with Administrators Group with AdministratorAccess permissions

**EC2**
- Launch new instance
- Default architecture & t2.micro, all defaults until Security - add TCP rule with port set to 8080
- Launch without a key/pair
- Open instance in console. Note Public DNS (IPv4) 

**Run application - via SSH in browser**
- Open instance in console, click "Connect" > "SSH in browser" > "Connect"
- Install node, install our basic server from github, run server

```bash
sudo yum -y update 
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.34.0/install.sh | bash
. ~/.nvm/nvm.sh
nvm install node
```
```bash
mkdir logs
curl -sL https://github.com/jmurphyweb/aws-bootstrap/archive/master.zip --output master.zip
unzip master.zip
mv aws-bootstrap-master app
cd app
npm install
npm start
curl localhost:8080
# Hello World
```
- Take public dns from console & hit: `http://<public_dns>:8080`
- Now can create a budget for EC2 instance in Billing section

## Infrastructure as Code - CloudFormation

**Set up AWS CLI**
```bash
# setup profile with access & secret key
aws configure --profile awsbootstrap
# check it is setup:
aws ec2 describe-instances --profile awsbootstrap
```

**Deploy Script**
- we use a script to execute the cloud formation template
- create `deploy-infra.sh`
- copy contents below
- make executable: `chmod +x deploy-infra.sh`
```bash
#!/bin/bash

STACK_NAME=awsbootstrap 
# STACK_NAME refers to group of resources we will manage
REGION=eu-west-1 
CLI_PROFILE=awsbootstrap
# CLI_PROFILE is the profile we have set up

EC2_INSTANCE_TYPE=t2.micro 

# Deploy the CloudFormation template
echo -e "\n\n=========== Deploying main.yml ==========="
aws cloudformation deploy \
--region $REGION \
--profile $CLI_PROFILE \
--stack-name $STACK_NAME \
--template-file main.yml \
--no-fail-on-empty-changeset \
--capabilities CAPABILITY_NAMED_IAM \
--parameter-overrides \
  EC2InstanceType=$EC2_INSTANCE_TYPE
```

**CloudFormation Template**
- 3 top level sections
- Parameters: - for adding flexibility to template
- Resources: - to define/configure resources CloudFormation will mangage
- Outputs: - allows us to locate created resources
- CloudFormation notes:
```yml
# !Sub CloudFormation function for string interpolation '${}'
#   eg: !Sub "http://${Instance.PublicDnsName}:8080" 

# !Ref function for referencing other resources within stack 
#   eg: !Ref EC2AMI

# !GetAtt CloudFormation function references attributes from other resources
#   eg: !GetAtt SecurityGroup.GroupId

# AWS::StackName a pseudo parameter
```

```yml
Parameters:
  EC2InstanceType:

  EC2AMI:
    # AMI = Amazon Machine Image
    # Reference special parameter type allowing template to access latest AMI

Resources:
  SecurityGroup: 
    # Acts as firewall
    # Allow traffic to port on 8080 (to reach application) & 22 (SSH access)

  InstanceRole:
    # Adds IAM role used by EC2 instance to define its permissions
    # Attach CloudWatchFullAccess policy

  InstanceProfile:
    # Ties our IAM role to EC2 instance

  Instance: 
    # Configures EC2 instance

Outputs:
  InstanceEndpoint:
    # references the URL generated by public "http://PublicDnsName:host"
    # Value: !Sub "http://${Instance.PublicDnsName}:8080"
```


### Automatic Deployments
We want to enable automated updates to instance on github merge

Introduction to:
- CodeBuild, CodeDeploy, CodePipeline

#### Generate & store GitHub access token
- generate access token with `repo` & `admin:repo-hook` permissions
- store variables in `~/.github/aws-bootstrap-xxx` files:
```bash
$ mkdir -p ~/.github
$ echo "aws-bootstrap" > ~/.github/aws-bootstrap-repo
$ echo "<username>" > ~/.github/aws-bootstrap-owner
$ echo "<token>" > ~/.github/aws-bootstrap-access-token 
```

#### S3 Buckets for build artefacts - setup.yml
- CodePipeline requires S3 Bucket to store artefacts built by CodeBuild
- CloudFormation cannot delete non-empty buckets so we put in separate stack - setup
- `deploy-infra.sh` runs this before running `main.yml`

```yml
# setup.yml
AWSTemplateFormatVersion: 2010-09-09

  Parameters:
    CodePipelineBucket:

  Resources:
    CodePipelineS3Bucket:
      Type: AWS::S3::Bucket
```

#### Start & Stop scripts
- `start-service.sh` runs `npm run start`
- `stop-service.sh` runs `npm stop`

#### CodeBuild specification - `buildspec.yml`
- Tell CodeBuild how to build our application
- CodeBuild has a specification which we use in `buildspec.yml`
- Runs `npm install && npm run build` and specifies relevant artefacts
- eg. node_modules, start/stop-service, server.js, package.json, appspec.yml

#### CodeDeploy specification - `appspec.yml`
- Tell CodeDeploy what to do with CodeBuild artefacts


